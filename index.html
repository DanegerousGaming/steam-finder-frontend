<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streams Friend Game Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .avatar-list img {
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        #game-modal, #help-modal, #scheduler-modal {
            transition: opacity 0.3s ease;
        }
        #game-modal-content, #help-modal-content, #scheduler-modal-content {
            transition: transform 0.3s ease;
        }
        .genre-filter-btn.active {
            background-color: #2563eb;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="login-screen" class="flex items-center justify-center h-screen">
        <div class="text-center p-8 bg-white rounded-lg shadow-xl">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">Streams Friend Game Finder</h1>
            <p class="text-gray-600 mb-8">Find the games you and your friends can play together.</p>
            <button id="login-button" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300">
                Sign in with Steam
            </button>
        </div>
    </div>

    <div id="app-dashboard" class="hidden">
        <header class="bg-white shadow-md p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold">Game Finder Dashboard</h1>
            <div id="user-profile" class="flex items-center"></div>
        </header>

        <main class="p-4 md:p-8 grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <aside class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-bold">Friends List</h2>
                    <i id="help-icon" class="fas fa-info-circle text-gray-400 cursor-pointer"></i>
                </div>
                <input type="text" id="friend-search" class="w-full p-2 border rounded-md mb-4" placeholder="Search friends...">
                <div id="friends-list" class="space-y-3 h-80 overflow-y-auto">
                    <div class="loader"></div>
                </div>
            </aside>

            <section class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-bold">Matching Games</h2>
                    <button id="plan-gamenight-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition text-sm">
                        <i class="fas fa-person-booth mr-2"></i>Democracy Button
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="game-search" class="block text-sm font-medium text-gray-700">Search for a specific game:</label>
                        <input type="text" id="game-search" class="w-full p-2 border rounded-md mt-1" placeholder="e.g., Counter-Strike 2">
                    </div>
                    <div>
                        <label for="threshold-select" class="block text-sm font-medium text-gray-700">Ownership Threshold:</label>
                        <select id="threshold-select" class="w-full p-2 border rounded-md mt-1">
                            <option value="1.0">100%</option>
                            <option value="0.9">90%</option>
                            <option value="0.8" selected>80%</option>
                            <option value="0.7">70%</option>
                            <option value="0.6">60%</option>
                            <option value="0.5">50%</option>
                            <option value="0.4">40%</option>
                            <option value="0.3">30%</option>
                            <option value="0.2">20%</option>
                            <option value="0.1">10%</option>
                        </select>
                    </div>
                </div>
                <div id="genre-filters" class="flex flex-wrap gap-2 mb-4"></div>
                <div id="shared-games-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 h-[40rem] overflow-y-auto p-2">
                     <p class="text-gray-500 col-span-full text-center mt-10">Please select some friends to see shared games.</p>
                </div>
            </section>

            <aside class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4 border-b pb-2">Group Management</h2>
                <div class="mb-4">
                    <h3 class="font-semibold mb-2">Selected Friends:</h3>
                    <div id="selected-friends-list" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="mb-4">
                    <label for="group-name" class="block font-semibold mb-2">Group Name:</label>
                    <input type="text" id="group-name" class="w-full p-2 border rounded-md" placeholder="e.g., Weekend Warriors">
                    <button id="save-group-button" class="w-full mt-2 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">Save Group</button>
                </div>
                <div class="mb-6">
                    <label for="saved-groups" class="block font-semibold mb-2">Load Group:</label>
                    <div class="flex items-center">
                        <select id="saved-groups" class="w-full p-2 border rounded-l-md"></select>
                        <button id="delete-group-btn" class="bg-red-500 text-white p-2 rounded-r-md hover:bg-red-600"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label for="currency-selector" class="block font-semibold mb-2">Currency:</label>
                    <select id="currency-selector" class="w-full p-2 border rounded-md">
                        <option value="AU">AUD ($)</option>
                        <option value="US">USD ($)</option>
                        <option value="GB">GBP (£)</option>
                        <option value="EU">EUR (€)</option>
                        <option value="NZ">NZD ($)</option>
                        <option value="CA">CAD ($)</option>
                    </select>
                </div>

                <h2 class="text-xl font-bold mb-4 border-b pb-2">Player Counts</h2>
                 <div id="player-count-list" class="h-48 overflow-y-auto text-sm space-y-2"></div>
            </aside>
        </main>
    </div>

    <!-- Modals -->
    <div id="game-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div id="game-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95"></div>
    </div>
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div id="help-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 transform scale-95"></div>
    </div>
    <div id="scheduler-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div id="scheduler-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-6 transform scale-95"></div>
    </div>


    <script>
        const BACKEND_URL = 'https://streamgamemate.vercel.app'; 

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const appDashboard = document.getElementById('app-dashboard');
        const loginButton = document.getElementById('login-button');
        const userProfileContainer = document.getElementById('user-profile');
        const friendsListContainer = document.getElementById('friends-list');
        const sharedGamesGrid = document.getElementById('shared-games-grid');
        const selectedFriendsList = document.getElementById('selected-friends-list');
        const gameModal = document.getElementById('game-modal');
        const gameModalContent = document.getElementById('game-modal-content');
        const friendSearch = document.getElementById('friend-search');
        const playerCountList = document.getElementById('player-count-list');
        const helpIcon = document.getElementById('help-icon');
        const helpModal = document.getElementById('help-modal');
        const schedulerModal = document.getElementById('scheduler-modal');
        const schedulerModalContent = document.getElementById('scheduler-modal-content');
        const planGameNightBtn = document.getElementById('plan-gamenight-btn');
        const genreFiltersContainer = document.getElementById('genre-filters');
        const currencySelector = document.getElementById('currency-selector');
        const thresholdSelect = document.getElementById('threshold-select');
        const gameSearchInput = document.getElementById('game-search');
        const saveGroupBtn = document.getElementById('save-group-button');
        const groupNameInput = document.getElementById('group-name');
        const savedGroupsSelect = document.getElementById('saved-groups');
        const deleteGroupBtn = document.getElementById('delete-group-btn');
        
        // State
        let user = null;
        let friends = [];
        let allGroupMembers = [];
        let selectedFriendIds = new Set();
        let allSharedGames = [];
        let activeGenreFilter = 'All';
        let selectedCurrency = localStorage.getItem('steamCurrency') || 'AU';
        let savedGroups = JSON.parse(localStorage.getItem('steamFriendGroups')) || {};

        async function apiFetch(endpoint) {
            try {
                const response = await fetch(`${BACKEND_URL}${endpoint}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error("API fetch error:", error);
                alert("Failed to fetch data from the server. Please check the console for details.");
                return null;
            }
        }

        function renderUserProfile() {
            userProfileContainer.innerHTML = `
                <span class="mr-4 font-medium">Welcome, ${user.personaname}!</span>
                <img src="${user.avatar}" class="w-10 h-10 rounded-full mr-4" alt="User Avatar">
                <button id="logout-button" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition">Logout</button>
            `;
            document.getElementById('logout-button').addEventListener('click', () => {
                window.location.href = window.location.pathname;
            });
        }

        function displayFriends(friendsToDisplay) {
            friendsListContainer.innerHTML = '';
            if (friendsToDisplay.length === 0) {
                friendsListContainer.innerHTML = '<p class="text-gray-500 p-4 text-center">No friends found.</p>';
                return;
            }
            friendsToDisplay.forEach(friend => {
                const friendDiv = document.createElement('div');
                const isSelected = selectedFriendIds.has(friend.steamid);
                const isPrivate = !friend.personaname;
                friendDiv.className = `p-3 rounded-lg cursor-pointer transition flex items-center justify-between ${isSelected ? 'bg-blue-500 text-white' : 'bg-gray-200'} ${isPrivate ? 'opacity-50' : ''}`;
                friendDiv.innerHTML = `<span>${isPrivate ? 'Private Profile' : friend.personaname}</span><img src="${friend.avatar}" class="w-8 h-8 rounded-full">`;
                friendDiv.dataset.friendId = friend.steamid;
                if (!isPrivate) {
                    friendDiv.onclick = () => toggleFriendSelection(friend.steamid, friendDiv);
                } else {
                    friendDiv.onclick = () => showHelpModal();
                }
                friendsListContainer.appendChild(friendDiv);
            });
        }

        async function fetchAndRenderFriends() {
            friendsListContainer.innerHTML = '<div class="loader"></div>';
            const data = await apiFetch(`/api/friends?steamid=${user.steamid}`);
            if (data && data.friendslist && data.friendslist.friends) {
                friends = data.friendslist.friends.sort((a, b) => (a.personaname || 'Z').localeCompare(b.personaname || 'Z'));
                allGroupMembers = [user, ...friends];
                displayFriends(friends);
            } else {
                friendsListContainer.innerHTML = '<p class="text-gray-500">Could not load friends list. Your profile might be private.</p>';
            }
        }

        function toggleFriendSelection(friendId, element) {
            if (selectedFriendIds.has(friendId)) {
                selectedFriendIds.delete(friendId);
            } else {
                selectedFriendIds.add(friendId);
            }
            displayFriends(friends);
            updateSharedGames();
            updateSelectedFriendsList();
        }
        
        function updateSelectedFriendsList() {
            selectedFriendsList.innerHTML = '';
            if (selectedFriendIds.size === 0) {
                selectedFriendsList.innerHTML = '<p class="text-gray-500">None selected.</p>';
                return;
            }
            selectedFriendIds.forEach(id => {
                const friend = friends.find(f => f.steamid === id);
                if (friend) {
                    const friendTag = document.createElement('span');
                    friendTag.className = 'bg-blue-200 text-blue-800 text-sm font-semibold mr-2 px-2.5 py-0.5 rounded';
                    friendTag.textContent = friend.personaname;
                    selectedFriendsList.appendChild(friendTag);
                }
            });
        }

        async function updateSharedGames() {
            if (selectedFriendIds.size === 0) {
                sharedGamesGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center mt-10">Please select some friends to see shared games.</p>';
                updatePlayerCountList([]);
                genreFiltersContainer.innerHTML = '';
                return;
            }

            sharedGamesGrid.innerHTML = '<div class="loader col-span-full"></div>';
            const allIds = [user.steamid, ...selectedFriendIds];
            const threshold = thresholdSelect.value;
            const data = await apiFetch(`/api/shared-games?steamids=${allIds.join(',')}&cc=${selectedCurrency.toLowerCase()}&threshold=${threshold}`);

            if (data && data.games) {
                allSharedGames = data.games;
                renderFilteredGames();
                renderGenreFilters();
            } else {
                 sharedGamesGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center mt-10">No games found for the selected threshold.</p>`;
                 updatePlayerCountList([]);
            }
        }
        
        function renderFilteredGames() {
            sharedGamesGrid.innerHTML = '';
            const filteredGames = activeGenreFilter === 'All' 
                ? allSharedGames 
                : allSharedGames.filter(g => g.genres && g.genres.some(genre => genre.description === activeGenreFilter));

            if (filteredGames.length > 0) {
                const bestMatch = findBestMatch(filteredGames);
                filteredGames.forEach(game => {
                    const gameCard = createGameCard(game, bestMatch === game.steam_appid);
                    sharedGamesGrid.appendChild(gameCard);
                });
                updatePlayerCountList(filteredGames);
            } else {
                sharedGamesGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center mt-10">No games found for the selected filter.</p>`;
                updatePlayerCountList([]);
            }
        }

        function createGameCard(game, isBestMatch) {
            const gameCard = document.createElement('div');
            gameCard.className = 'game-card bg-gray-50 rounded-lg shadow-md overflow-hidden cursor-pointer transition-transform hover:scale-105 relative';
            
            const allIds = [user.steamid, ...selectedFriendIds];
            const ownershipPercentage = (game.owners.length / allIds.length) * 100;
            const avgPlaytime = calculateAveragePlaytime(game.playtimes, game.owners);

            gameCard.innerHTML = `
                ${isBestMatch ? '<div class="absolute top-2 -left-2 bg-yellow-400 text-yellow-800 text-xs font-bold px-3 py-1 rounded-r-full shadow-lg transform -rotate-12">⭐ Best Match</div>' : ''}
                <div class="relative">
                    <img src="${game.header_image}" alt="${game.name}" class="w-full h-48 object-cover">
                    <div class="absolute bottom-2 right-2 bg-black bg-opacity-60 text-white text-xs font-bold px-2 py-1 rounded">
                        ${(game.player_count || 0).toLocaleString()} players
                    </div>
                </div>
                <div class="p-4">
                    <h3 class="text-lg font-bold truncate">${game.name}</h3>
                    <p class="text-xs text-gray-500 font-medium">Avg. Playtime: ${avgPlaytime} hrs</p>
                    <div class="mt-2">
                        <div class="flex justify-between items-center text-sm font-semibold text-gray-600 mb-1">
                            <span>Ownership</span>
                            <span>${game.owners.length} / ${allIds.length}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${ownershipPercentage}%"></div>
                        </div>
                    </div>
                </div>
            `;
            gameCard.addEventListener('click', () => showGameModal(game, allIds.length));
            return gameCard;
        }

        function renderGenreFilters() {
            const genres = new Set();
            allSharedGames.forEach(game => {
                if (game.genres) {
                    game.genres.forEach(genre => genres.add(genre.description));
                }
            });

            genreFiltersContainer.innerHTML = `<button class="genre-filter-btn active bg-gray-200 text-gray-800 text-xs font-bold px-3 py-1 rounded-full" data-genre="All">All</button>`;
            [...genres].sort().forEach(genre => {
                genreFiltersContainer.innerHTML += `<button class="genre-filter-btn bg-gray-200 text-gray-800 text-xs font-bold px-3 py-1 rounded-full" data-genre="${genre}">${genre}</button>`;
            });

            document.querySelectorAll('.genre-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelector('.genre-filter-btn.active').classList.remove('active');
                    btn.classList.add('active');
                    activeGenreFilter = btn.dataset.genre;
                    renderFilteredGames();
                });
            });
        }

        function calculateAveragePlaytime(playtimes, owners) {
            if (!playtimes || owners.length === 0) return 0;
            const totalMinutes = owners.reduce((sum, ownerId) => sum + (playtimes[ownerId] || 0), 0);
            return Math.round(totalMinutes / owners.length / 60);
        }

        function findBestMatch(games) {
            let bestGame = null;
            let lowestVariance = Infinity;

            games.forEach(game => {
                const playtimesInHours = game.owners.map(id => (game.playtimes[id] || 0) / 60);
                if (playtimesInHours.length < 2) return;

                const mean = playtimesInHours.reduce((a, b) => a + b, 0) / playtimesInHours.length;
                const variance = playtimesInHours.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / playtimesInHours.length;

                if (variance < lowestVariance) {
                    lowestVariance = variance;
                    bestGame = game.steam_appid;
                }
            });
            return bestGame;
        }

        function showGameModal(game, totalPlayers) {
            let priceHTML = `<p class="text-2xl font-bold text-green-600">${game.price_overview ? game.price_overview.final_formatted : 'Free to Play'}</p>`;
            if (game.price_overview && game.price_overview.discount_percent > 0) {
                priceHTML = `<div class="text-right">
                                <p class="text-2xl font-bold text-red-500">${game.price_overview.final_formatted}</p>
                                <p class="text-md text-gray-500 line-through">${game.price_overview.initial_formatted}</p>
                             </div>`;
            } else if (!game.price_overview && !game.is_free) {
                priceHTML = `<p class="text-2xl font-bold text-gray-700">N/A</p>`;
            }

            const getAvatar = (id) => allGroupMembers.find(m => m.steamid === id)?.avatar || '';
            const ownersHTML = game.owners.map(id => `<img src="${getAvatar(id)}" class="w-10 h-10 rounded-full border-2 border-white" title="${allGroupMembers.find(m => m.steamid === id)?.personaname || ''}">`).join('');
            const nonOwnersHTML = game.nonOwners.map(id => `<img src="${getAvatar(id)}" class="w-10 h-10 rounded-full border-2 border-white" title="${allGroupMembers.find(m => m.steamid === id)?.personaname || ''}">`).join('');

            gameModalContent.innerHTML = `
                <img src="${game.header_image}" alt="${game.name}" class="w-full h-48 object-cover rounded-t-lg">
                <div class="p-6">
                    <div class="flex justify-between items-start">
                        <h2 class="text-3xl font-bold mb-2">${game.name}</h2>
                        <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    </div>
                    <p class="text-gray-600 mb-6">${game.short_description || ''}</p>
                    
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-3">Ownership Details (${game.owners.length} / ${totalPlayers})</h3>
                        <div class="mb-4">
                            <h4 class="font-semibold text-green-700 mb-2">Who Has It:</h4>
                            <div class="flex flex-wrap gap-2">${ownersHTML || 'None'}</div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-red-700 mb-2">Who Needs It:</h4>
                            <div class="flex flex-wrap gap-2">${nonOwnersHTML || 'None'}</div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mt-6 pt-4 border-t">
                        <div class="text-gray-700">
                            <span class="font-bold">${(game.player_count || 0).toLocaleString()}</span>
                            <span> players online now</span>
                        </div>
                        ${priceHTML}
                    </div>
                </div>
            `;

            gameModal.classList.remove('hidden');
            setTimeout(() => {
                gameModal.classList.remove('opacity-0');
                gameModalContent.classList.remove('scale-95');
            }, 10);

            document.getElementById('close-modal-btn').addEventListener('click', hideGameModal);
        }

        function hideGameModal() {
            gameModal.classList.add('opacity-0');
            gameModalContent.classList.add('scale-95');
            setTimeout(() => {
                gameModal.classList.add('hidden');
            }, 300);
        }

        function showHelpModal() {
            helpModalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Private Profiles</h2>
                    <button id="close-help-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>
                <p class="mb-4">If a friend is not appearing in your list, or if their games aren't showing up, their Steam profile is likely set to "Private" or "Friends Only".</p>
                <p class="font-bold mb-2">How to fix it:</p>
                <ol class="list-decimal list-inside space-y-2 text-gray-700">
                    <li>Open Steam and go to your Profile page.</li>
                    <li>Click the "Edit Profile" button.</li>
                    <li>Go to the "Privacy Settings" tab on the left.</li>
                    <li>Set "My Profile" and "Game Details" to <strong>Public</strong>.</li>
                </ol>
            `;
            helpModal.classList.remove('hidden');
            setTimeout(() => {
                helpModal.classList.remove('opacity-0');
                helpModalContent.classList.remove('scale-95');
            }, 10);
            document.getElementById('close-help-btn').addEventListener('click', hideHelpModal);
        }

        function hideHelpModal() {
            helpModal.classList.add('opacity-0');
            helpModalContent.classList.add('scale-95');
            setTimeout(() => {
                helpModal.classList.add('hidden');
            }, 300);
        }

        function updatePlayerCountList(games) {
            playerCountList.innerHTML = '';
            if (games.length === 0) {
                playerCountList.innerHTML = '<p class="text-gray-500">No games to display.</p>';
                return;
            }
            games
                .sort((a, b) => (b.player_count || 0) - (a.player_count || 0))
                .forEach(game => {
                    const gameDiv = document.createElement('div');
                    gameDiv.className = 'flex justify-between items-center';
                    gameDiv.innerHTML = `
                        <span class="truncate pr-2">${game.name}</span>
                        <span class="font-bold">${(game.player_count || 0).toLocaleString()}</span>
                    `;
                    playerCountList.appendChild(gameDiv);
                });
        }
        
        function showSchedulerModal() {
            const topGames = allSharedGames.sort((a,b) => b.owners.length - a.owners.length).slice(0, 5);
            
            const gameOptionsHTML = topGames.map(game => `
                <label class="flex items-center space-x-2 p-2 rounded-md hover:bg-gray-100">
                    <input type="checkbox" name="game-vote" value="${game.name}" class="h-4 w-4">
                    <span>${game.name}</span>
                </label>
            `).join('');

            schedulerModalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Democracy!</h2>
                    <button id="close-scheduler-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>
                <p class="mb-4 text-gray-600">Create a poll for your friends to vote on what to play.</p>
                <div class="mb-4">
                    <label class="font-bold">1. Games to Vote On:</label>
                    <div class="mt-2 space-y-1">${gameOptionsHTML}</div>
                </div>
                <div id="poll-output" class="hidden mt-6">
                    <label class="font-bold">2. Copy & Paste this into your chat:</label>
                    <textarea id="poll-textarea" class="w-full p-2 border rounded-md bg-gray-100 mt-2" rows="5" readonly></textarea>
                    <button id="copy-poll-btn" class="w-full mt-2 bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Copy Poll</button>
                </div>
                <button id="create-poll-btn" class="w-full mt-6 bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition">Generate Poll Text</button>
            `;
            
            schedulerModal.classList.remove('hidden');
            setTimeout(() => {
                schedulerModal.classList.remove('opacity-0');
                schedulerModalContent.classList.remove('scale-95');
            }, 10);

            document.getElementById('close-scheduler-btn').addEventListener('click', hideSchedulerModal);
            document.getElementById('create-poll-btn').addEventListener('click', createPollText);
        }

        function hideSchedulerModal() {
            schedulerModal.classList.add('opacity-0');
            schedulerModalContent.classList.add('scale-95');
            setTimeout(() => schedulerModal.classList.add('hidden'), 300);
        }

        function createPollText() {
            const selectedGames = Array.from(document.querySelectorAll('input[name="game-vote"]:checked')).map(cb => cb.value);
            if (selectedGames.length === 0) {
                alert('Please select at least one game to vote on.');
                return;
            }
            
            let pollText = "Alright team, what are we playing?\n\n";
            selectedGames.forEach((game, index) => {
                pollText += `${index + 1}️⃣ ${game}\n`;
            });

            const pollOutput = document.getElementById('poll-output');
            const pollTextarea = document.getElementById('poll-textarea');
            pollTextarea.value = pollText;
            pollOutput.classList.remove('hidden');

            const copyBtn = document.getElementById('copy-poll-btn');
            copyBtn.addEventListener('click', () => {
                pollTextarea.select();
                document.execCommand('copy');
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = 'Copy Poll', 2000);
            });
        }

        function saveGroup() {
            const name = groupNameInput.value.trim();
            if (!name) {
                alert('Please enter a group name.');
                return;
            }
            if (selectedFriendIds.size === 0) {
                alert('Please select friends to save to the group.');
                return;
            }
            savedGroups[name] = [...selectedFriendIds];
            localStorage.setItem('steamFriendGroups', JSON.stringify(savedGroups));
            alert(`Group "${name}" saved!`);
            groupNameInput.value = '';
            loadSavedGroups();
        }

        function loadSavedGroups() {
            savedGroupsSelect.innerHTML = '<option value="">Load a saved group...</option>';
            for (const name in savedGroups) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                savedGroupsSelect.appendChild(option);
            }
        }
        
        function deleteGroup() {
            const groupName = savedGroupsSelect.value;
            if (!groupName) {
                alert('Please select a group to delete.');
                return;
            }
            if (confirm(`Are you sure you want to delete the group "${groupName}"?`)) {
                delete savedGroups[groupName];
                localStorage.setItem('steamFriendGroups', JSON.stringify(savedGroups));
                alert(`Group "${groupName}" deleted.`);
                loadSavedGroups();
            }
        }

        function handleGroupLoad(e) {
            const groupName = e.target.value;
            if (!groupName) {
                selectedFriendIds.clear();
            } else {
                selectedFriendIds = new Set(savedGroups[groupName]);
            }
            displayFriends(friends);
            updateSharedGames();
            updateSelectedFriendsList();
        }

        async function handleGameSearch() {
            const query = gameSearchInput.value.trim();
            if (query.length < 3) {
                if (query.length === 0) updateSharedGames();
                return;
            }
            if (selectedFriendIds.size === 0) {
                alert('Please select some friends before searching for a game.');
                return;
            }

            sharedGamesGrid.innerHTML = '<div class="loader col-span-full"></div>';
            const allIds = [user.steamid, ...selectedFriendIds];
            const data = await apiFetch(`/api/search-game?query=${encodeURIComponent(query)}&steamids=${allIds.join(',')}&cc=${selectedCurrency.toLowerCase()}`);
            
            allSharedGames = data.games || [];
            activeGenreFilter = 'All';
            renderFilteredGames();
            renderGenreFilters();
        }


        // Event Listeners
        loginButton.addEventListener('click', () => window.location.href = `${BACKEND_URL}/auth/steam`);
        gameModal.addEventListener('click', (e) => { if (e.target === gameModal) hideGameModal(); });
        helpIcon.addEventListener('click', showHelpModal);
        helpModal.addEventListener('click', (e) => { if (e.target === helpModal) hideHelpModal(); });
        schedulerModal.addEventListener('click', (e) => { if (e.target === schedulerModal) hideSchedulerModal(); });
        planGameNightBtn.addEventListener('click', showSchedulerModal);
        currencySelector.addEventListener('change', (e) => {
            selectedCurrency = e.target.value;
            localStorage.setItem('steamCurrency', selectedCurrency);
            if (selectedFriendIds.size > 0) updateSharedGames();
        });
        thresholdSelect.addEventListener('change', updateSharedGames);
        gameSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleGameSearch();
        });
        saveGroupBtn.addEventListener('click', saveGroup);
        savedGroupsSelect.addEventListener('change', handleGroupLoad);
        deleteGroupBtn.addEventListener('click', deleteGroup);

        window.onload = async () => {
            currencySelector.value = selectedCurrency;
            loadSavedGroups();
            const urlParams = new URLSearchParams(window.location.search);
            const steamid = urlParams.get('steamid');

            if (steamid) {
                const data = await apiFetch(`/api/user?steamid=${steamid}`);
                if (data && data.response && data.response.players.length > 0) {
                    user = data.response.players[0];
                    loginScreen.classList.add('hidden');
                    appDashboard.classList.remove('hidden');
                    renderUserProfile();
                    fetchAndRenderFriends();
                    updatePlayerCountList([]);
                } else {
                    alert('Could not verify user. Please try logging in again.');
                }
            }
        };

    </script>
</body>
</html>
