<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streams Friend Game Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #game-modal, #help-modal, #scheduler-modal {
            transition: opacity 0.3s ease;
        }
        #game-modal-content, #help-modal-content, #scheduler-modal-content {
            transition: transform 0.3s ease;
        }
        .genre-filter-btn.active {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="login-screen" class="flex items-center justify-center h-screen">
        <div class="text-center p-8 bg-white rounded-lg shadow-xl max-w-md mx-auto">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">Streams Friend Game Finder</h1>
            <p class="text-gray-600 mb-8">Find the multiplayer games you and your friends can actually play together.</p>
            <button id="login-button" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                <i class="fab fa-steam mr-2"></i> Sign in with Steam
            </button>
        </div>
    </div>

    <div id="app-dashboard" class="hidden">
        <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-40">
            <h1 class="text-2xl font-bold text-gray-900">Game Finder</h1>
            <div id="user-profile" class="flex items-center"></div>
        </header>

        <main class="p-4 md:p-8 grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <aside class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg h-fit">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-xl font-bold">Friends List</h2>
                    <i id="help-icon" class="fas fa-question-circle text-gray-400 hover:text-blue-500 cursor-pointer transition"></i>
                </div>
                <input type="text" id="friend-search" class="w-full p-2 border rounded-md mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Search friends...">
                <div id="friends-list" class="space-y-3 h-96 overflow-y-auto pr-2">
                    <div class="loader"></div>
                </div>
            </aside>

            <section class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b pb-3">
                    <h2 class="text-xl font-bold mb-2 sm:mb-0">Matching Games</h2>
                    <div id="scan-info" class="text-sm text-gray-500 text-left sm:text-right"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="threshold-select" class="block text-sm font-medium text-gray-700">Ownership Threshold:</label>
                        <select id="threshold-select" class="w-full p-2 border rounded-md mt-1 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="1.0">100%</option>
                            <option value="0.9">90%</option>
                            <option value="0.8" selected>80%</option>
                            <option value="0.7">70%</option>
                            <option value="0.6">60%</option>
                            <option value="0.5">50%</option>
                            <option value="0.4">40%</option>
                            <option value="0.3">30%</option>
                            <option value="0.2">20%</option>
                            <option value="0.1">10%</option>
                        </select>
                    </div>
                     <div>
                        <label for="sort-select" class="block text-sm font-medium text-gray-700">Sort By:</label>
                        <select id="sort-select" class="w-full p-2 border rounded-md mt-1 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="owners">Ownership</option>
                            <option value="players">Players Online</option>
                            <option value="name">Name (A-Z)</option>
                        </select>
                    </div>
                </div>
                <div id="genre-filters" class="flex flex-wrap gap-2 mb-4"></div>
                <div id="shared-games-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 h-[44rem] overflow-y-auto p-2">
                     <p class="text-gray-500 col-span-full text-center mt-10">Select friends from the list to find games you can play together.</p>
                </div>
            </section>

            <aside class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg h-fit">
                <h2 class="text-xl font-bold mb-4 border-b pb-2">Group Details</h2>
                <div class="mb-4">
                    <h3 class="font-semibold mb-2 text-gray-700">Selected Friends (<span id="selected-count">0</span>):</h3>
                    <div id="selected-friends-list" class="flex flex-wrap gap-2">
                        <p class="text-gray-500 text-sm">None selected.</p>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="group-name" class="block font-semibold mb-2">Group Name:</label>
                    <input type="text" id="group-name" class="w-full p-2 border rounded-md" placeholder="e.g., Weekend Warriors">
                    <button id="save-group-button" class="w-full mt-2 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">Save Group</button>
                </div>
                <div class="mb-6">
                    <label for="saved-groups" class="block font-semibold mb-2">Load Group:</label>
                    <div class="flex items-center">
                        <select id="saved-groups" class="w-full p-2 border rounded-l-md bg-white"></select>
                        <button id="delete-group-btn" class="bg-red-500 text-white p-2.5 rounded-r-md hover:bg-red-600"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                 <div class="mb-4">
                    <button id="plan-gamenight-btn" class="w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-poll mr-2"></i>Create Poll For Chat
                    </button>
                </div>
            </aside>
        </main>
    </div>

    <!-- Modals -->
    <div id="game-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div id="game-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95"></div>
    </div>
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div id="help-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 transform scale-95"></div>
    </div>
    <div id="scheduler-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div id="scheduler-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-6 transform scale-95"></div>
    </div>


    <script>
        const BACKEND_URL = 'https://streamgamemate.vercel.app'; 

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const appDashboard = document.getElementById('app-dashboard');
        const loginButton = document.getElementById('login-button');
        const userProfileContainer = document.getElementById('user-profile');
        const friendsListContainer = document.getElementById('friends-list');
        const sharedGamesGrid = document.getElementById('shared-games-grid');
        const selectedFriendsList = document.getElementById('selected-friends-list');
        const selectedCount = document.getElementById('selected-count');
        const gameModal = document.getElementById('game-modal');
        const gameModalContent = document.getElementById('game-modal-content');
        const friendSearchInput = document.getElementById('friend-search');
        const helpIcon = document.getElementById('help-icon');
        const helpModal = document.getElementById('help-modal');
        const schedulerModal = document.getElementById('scheduler-modal');
        const schedulerModalContent = document.getElementById('scheduler-modal-content');
        const planGameNightBtn = document.getElementById('plan-gamenight-btn');
        const genreFiltersContainer = document.getElementById('genre-filters');
        const thresholdSelect = document.getElementById('threshold-select');
        const sortSelect = document.getElementById('sort-select');
        const saveGroupBtn = document.getElementById('save-group-button');
        const groupNameInput = document.getElementById('group-name');
        const savedGroupsSelect = document.getElementById('saved-groups');
        const deleteGroupBtn = document.getElementById('delete-group-btn');
        const scanInfo = document.getElementById('scan-info');
        
        // State
        let user = null;
        let friends = [];
        let allGroupMembers = [];
        let selectedFriendIds = new Set();
        let allSharedGames = [];
        let activeGenreFilter = 'All';
        let savedGroups = JSON.parse(localStorage.getItem('steamFriendGroups')) || {};
        let publicProfilesScanned = 0;

        async function apiFetch(endpoint) {
            try {
                const response = await fetch(`${BACKEND_URL}${endpoint}`);
                if (!response.ok) {
                     const errorData = await response.json().catch(() => ({ message: 'An unknown error occurred' }));
                    throw new Error(errorData.message);
                }
                return await response.json();
            } catch (error) {
                console.error("API fetch error:", error);
                return { error: true, message: error.message };
            }
        }

        function renderUserProfile() {
            userProfileContainer.innerHTML = `
                <span class="mr-4 font-medium">Welcome, ${user.personaname}!</span>
                <img src="${user.avatarfull}" class="w-10 h-10 rounded-full mr-4" alt="User Avatar">
                <button id="logout-button" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition">Logout</button>
            `;
            document.getElementById('logout-button').addEventListener('click', () => {
                // Clear session data and reload
                window.location.href = window.location.pathname;
            });
        }

        function displayFriends(friendsToDisplay) {
            friendsListContainer.innerHTML = '';
            if (friendsToDisplay.length === 0) {
                friendsListContainer.innerHTML = '<p class="text-gray-500 p-4 text-center">No friends found.</p>';
                return;
            }
            friendsToDisplay.forEach(friend => {
                const friendDiv = document.createElement('div');
                const isSelected = selectedFriendIds.has(friend.steamid);
                const isPrivate = !friend.personaname;
                friendDiv.className = `p-3 rounded-lg cursor-pointer transition flex items-center justify-between ${isSelected ? 'bg-blue-500 text-white shadow-md' : 'bg-gray-100 hover:bg-gray-200'} ${isPrivate ? 'opacity-50 cursor-not-allowed' : ''}`;
                friendDiv.innerHTML = `
                    <span class="font-medium truncate pr-2">${isPrivate ? 'Private Profile' : friend.personaname}</span>
                    <img src="${friend.avatar}" class="w-8 h-8 rounded-full">
                `;
                friendDiv.dataset.friendId = friend.steamid;
                if (!isPrivate) {
                    friendDiv.onclick = () => toggleFriendSelection(friend.steamid);
                } else {
                    friendDiv.title = "This profile is private and cannot be scanned.";
                }
                friendsListContainer.appendChild(friendDiv);
            });
        }

        async function fetchAndRenderFriends() {
            friendsListContainer.innerHTML = '<div class="loader"></div>';
            const data = await apiFetch(`/api/friends?steamid=${user.steamid}`);
            if (data && !data.error && data.friendslist && data.friendslist.friends) {
                friends = data.friendslist.friends.sort((a, b) => (a.personaname || 'Z').localeCompare(b.personaname || 'Z'));
                // The user is always part of the group for scanning
                allGroupMembers = [user, ...friends];
                displayFriends(friends);
            } else {
                friendsListContainer.innerHTML = `<p class="text-red-500 p-4">${data.message || 'Could not load friends list.'}</p>`;
            }
        }

        function toggleFriendSelection(friendId) {
            if (selectedFriendIds.has(friendId)) {
                selectedFriendIds.delete(friendId);
            } else {
                selectedFriendIds.add(friendId);
            }
            // Re-render the friends list to show selection state
            const currentSearch = friendSearchInput.value.toLowerCase();
            const filteredFriends = friends.filter(f => (f.personaname || '').toLowerCase().includes(currentSearch));
            displayFriends(filteredFriends);
            
            updateSharedGames();
            updateSelectedFriendsList();
        }
        
        function updateSelectedFriendsList() {
            selectedFriendsList.innerHTML = '';
            selectedCount.textContent = selectedFriendIds.size;
            if (selectedFriendIds.size === 0) {
                selectedFriendsList.innerHTML = '<p class="text-gray-500 text-sm">None selected.</p>';
                return;
            }
            selectedFriendIds.forEach(id => {
                const friend = friends.find(f => f.steamid === id);
                if (friend) {
                    const friendTag = document.createElement('span');
                    friendTag.className = 'bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full';
                    friendTag.textContent = friend.personaname;
                    selectedFriendsList.appendChild(friendTag);
                }
            });
        }

        async function updateSharedGames() {
            if (selectedFriendIds.size === 0) {
                sharedGamesGrid.innerHTML = '<p class="text-gray-500 col-span-full text-center mt-10">Select friends from the list to find games you can play together.</p>';
                scanInfo.innerHTML = '';
                genreFiltersContainer.innerHTML = '';
                return;
            }

            sharedGamesGrid.innerHTML = '<div class="loader col-span-full"></div>';
            scanInfo.innerHTML = 'Scanning libraries...';
            // Always include the logged-in user in the scan
            const allIds = [user.steamid, ...selectedFriendIds];
            const threshold = thresholdSelect.value;
            const data = await apiFetch(`/api/shared-games?steamids=${allIds.join(',')}&threshold=${threshold}`);

            if (data.error) {
                sharedGamesGrid.innerHTML = `<p class="text-red-500 col-span-full text-center mt-10">${data.message}</p>`;
                scanInfo.innerHTML = '<span class="text-red-500">Scan failed</span>';
                return;
            }
            
            publicProfilesScanned = data.publicProfilesScanned;
            if (data.publicProfilesScanned < data.totalProfilesRequested) {
                 scanInfo.innerHTML = `<i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>Scanned ${data.publicProfilesScanned} of ${data.totalProfilesRequested} profiles. Others may be private.`;
            } else {
                 scanInfo.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i>Scanned all ${data.publicProfilesScanned} profiles successfully.`;
            }

            allSharedGames = data.games || [];
            if (allSharedGames.length === 0) {
                 sharedGamesGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center mt-10">No games found for the selected threshold.</p>`;
            }

            renderFilteredGames();
            renderGenreFilters();
        }
        
        function renderFilteredGames() {
            sharedGamesGrid.innerHTML = '';
            
            const baseGames = allSharedGames.filter(g => g.type !== 'dlc' && g.type !== 'advertising');

            const sortBy = sortSelect.value;
            baseGames.sort((a, b) => {
                if (sortBy === 'players') {
                    return (b.player_count || 0) - (a.player_count || 0);
                }
                if (sortBy === 'name') {
                    return a.name.localeCompare(b.name);
                }
                // Default to 'owners'
                return b.owners.length - a.owners.length;
            });

            const filteredGames = activeGenreFilter === 'All' 
                ? baseGames 
                : baseGames.filter(g => g.genres && g.genres.some(genre => genre.description === activeGenreFilter));

            if (filteredGames.length > 0) {
                filteredGames.forEach(game => {
                    const gameCard = createGameCard(game);
                    sharedGamesGrid.appendChild(gameCard);
                });
            } else {
                sharedGamesGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center mt-10">No games match the selected genre filter.</p>`;
            }
        }

        function createGameCard(game) {
            const gameCard = document.createElement('div');
            gameCard.className = 'game-card bg-gray-50 rounded-lg shadow-md overflow-hidden cursor-pointer transition-transform hover:scale-105 relative flex flex-col';
            
            // THE FIX: Use publicProfilesScanned from the API as the denominator.
            const denominator = publicProfilesScanned;
            const ownershipPercentage = denominator > 0 ? (game.owners.length / denominator) * 100 : 0;

            gameCard.innerHTML = `
                <div class="relative">
                    <img src="${game.header_image}" alt="${game.name}" class="w-full h-40 object-cover" onerror="this.style.display='none'">
                    <div class="absolute bottom-2 right-2 bg-black bg-opacity-70 text-white text-xs font-bold px-2 py-1 rounded">
                        <i class="fas fa-users mr-1"></i> ${(game.player_count || 0).toLocaleString()}
                    </div>
                </div>
                <div class="p-4 flex flex-col flex-grow">
                    <h3 class="text-lg font-bold truncate" title="${game.name}">${game.name}</h3>
                    <div class="mt-2 flex-grow">
                        <div class="flex justify-between items-center text-sm font-semibold text-gray-600 mb-1">
                            <span>Ownership</span>
                            <span>${game.owners.length} / ${denominator}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${ownershipPercentage}%"></div>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-3">
                        ${(game.genres || []).slice(0, 2).map(g => g.description).join(', ')}
                    </p>
                </div>
            `;
            gameCard.addEventListener('click', () => showGameModal(game));
            return gameCard;
        }

        function renderGenreFilters() {
            const genres = new Set();
            allSharedGames.forEach(game => {
                if (game.genres) {
                    game.genres.forEach(genre => genres.add(genre.description));
                }
            });

            genreFiltersContainer.innerHTML = `<button class="genre-filter-btn active bg-gray-200 text-gray-700 text-xs font-medium px-3 py-1 rounded-full" data-genre="All">All Genres</button>`;
            [...genres].sort().forEach(genre => {
                genreFiltersContainer.innerHTML += `<button class="genre-filter-btn bg-gray-200 text-gray-700 text-xs font-medium px-3 py-1 rounded-full" data-genre="${genre}">${genre}</button>`;
            });

            document.querySelectorAll('.genre-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelector('.genre-filter-btn.active').classList.remove('active', 'bg-blue-600', 'text-white', 'font-semibold');
                    btn.classList.add('active', 'bg-blue-600', 'text-white', 'font-semibold');
                    activeGenreFilter = btn.dataset.genre;
                    renderFilteredGames();
                });
            });
        }

        function showGameModal(game) {
            // THE FIX: Use publicProfilesScanned from the API as the denominator.
            const denominator = publicProfilesScanned;
            let priceHTML = `<p class="text-2xl font-bold text-green-600">${game.price_overview ? game.price_overview.final_formatted : 'Free to Play'}</p>`;
            if (game.price_overview && game.price_overview.discount_percent > 0) {
                priceHTML = `<div class="text-right">
                                <p class="text-2xl font-bold text-red-500">${game.price_overview.final_formatted} (-${game.price_overview.discount_percent}%)</p>
                                <p class="text-md text-gray-500 line-through">${game.price_overview.initial_formatted}</p>
                             </div>`;
            } else if (!game.price_overview && !game.is_free) {
                priceHTML = `<p class="text-2xl font-bold text-gray-700">Price not available</p>`;
            }

            const getAvatar = (id) => allGroupMembers.find(m => m.steamid === id)?.avatar || `https://placehold.co/40x40/222/fff?text=?`;
            const ownersHTML = game.owners.map(id => `<img src="${getAvatar(id)}" class="w-10 h-10 rounded-full border-2 border-white" title="${allGroupMembers.find(m => m.steamid === id)?.personaname || 'Unknown'}">`).join('');
            const nonOwnersHTML = game.nonOwners.map(id => `<img src="${getAvatar(id)}" class="w-10 h-10 rounded-full border-2 border-white" title="${allGroupMembers.find(m => m.steamid === id)?.personaname || 'Unknown'}">`).join('');

            gameModalContent.innerHTML = `
                <div class="relative">
                     <img src="${game.background_raw || game.header_image}" alt="${game.name}" class="w-full h-56 object-cover rounded-t-lg">
                     <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                     <button id="close-modal-btn" class="absolute top-4 right-4 text-white hover:text-gray-300 text-3xl font-bold">&times;</button>
                     <h2 class="absolute bottom-4 left-4 text-3xl font-bold text-white shadow-lg">${game.name}</h2>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 mb-6">${game.short_description || ''}</p>
                    
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <h3 class="font-bold text-lg mb-3">Ownership Details (${game.owners.length} / ${denominator})</h3>
                        <div class="mb-4">
                            <h4 class="font-semibold text-green-700 mb-2">Who Has It:</h4>
                            <div class="flex flex-wrap gap-2">${ownersHTML || '<span class="text-sm text-gray-500">None</span>'}</div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-red-700 mb-2">Who Needs It:</h4>
                            <div class="flex flex-wrap gap-2">${nonOwnersHTML || '<span class="text-sm text-gray-500">Everyone has it!</span>'}</div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mt-6 pt-4 border-t">
                        <a href="steam://run/${game.steam_appid}" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Launch Game</a>
                        ${priceHTML}
                    </div>
                </div>
            `;

            gameModal.classList.remove('hidden');
            setTimeout(() => {
                gameModal.classList.remove('opacity-0');
                gameModalContent.classList.remove('scale-95');
            }, 10);

            document.getElementById('close-modal-btn').addEventListener('click', hideGameModal);
        }

        function hideGameModal() {
            gameModal.classList.add('opacity-0');
            gameModalContent.classList.add('scale-95');
            setTimeout(() => { gameModal.classList.add('hidden'); }, 300);
        }

        function showHelpModal() {
            // ... (rest of modal functions are fine)
        }
        // ... (other modal and helper functions)

        // --- EVENT LISTENERS ---
        loginButton.addEventListener('click', () => window.location.href = `${BACKEND_URL}/auth/steam`);
        friendSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredFriends = friends.filter(f => (f.personaname || '').toLowerCase().includes(query));
            displayFriends(filteredFriends);
        });
        
        const debouncedUpdate = debounce(updateSharedGames, 500);
        thresholdSelect.addEventListener('change', debouncedUpdate);
        sortSelect.addEventListener('change', renderFilteredGames);


        // --- INITIALIZATION ---
        window.onload = async () => {
            loadSavedGroups();
            const urlParams = new URLSearchParams(window.location.search);
            const steamid = urlParams.get('steamid');

            if (steamid) {
                const data = await apiFetch(`/api/user?steamid=${steamid}`);
                if (data && data.response && data.response.players.length > 0) {
                    user = data.response.players[0];
                    loginScreen.classList.add('hidden');
                    appDashboard.classList.remove('hidden');
                    renderUserProfile();
                    await fetchAndRenderFriends();
                } else {
                    alert('Could not verify user. Please try logging in again.');
                    loginScreen.classList.remove('hidden');
                }
                // Clean the URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                loginScreen.classList.remove('hidden');
            }
        };

        // Utility to prevent API spam
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
        
        // --- All other helper functions like modals, group saving etc. go here ---
        // (These are omitted for brevity but should be copied from the original file if needed)
        
        function showHelpModal() {
            helpModalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">How This Works & Private Profiles</h2>
                    <button id="close-help-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>
                <p class="mb-4">This tool can only see the game libraries of users who have their Steam profile set to Public.</p>
                <p class="mb-4">If a friend is grayed out or you're seeing a message about private profiles, it means they need to update their settings.</p>
                <p class="font-bold mb-2">How to fix it:</p>
                <ol class="list-decimal list-inside space-y-2 text-gray-700">
                    <li>Open Steam and go to your Profile page.</li>
                    <li>Click the "Edit Profile" button.</li>
                    <li>Go to the "Privacy Settings" tab on the left.</li>
                    <li>Set "My Profile" and "Game Details" to <strong>Public</strong>.</li>
                </ol>
            `;
            helpModal.classList.remove('hidden');
            setTimeout(() => {
                helpModal.classList.remove('opacity-0');
                helpModalContent.classList.remove('scale-95');
            }, 10);
            document.getElementById('close-help-btn').addEventListener('click', hideHelpModal);
        }

        function hideHelpModal() {
            helpModal.classList.add('opacity-0');
            helpModalContent.classList.add('scale-95');
            setTimeout(() => { helpModal.classList.add('hidden'); }, 300);
        }
        
        function showSchedulerModal() {
            const topGames = allSharedGames.sort((a,b) => b.owners.length - a.owners.length).slice(0, 10);
            
            const gameOptionsHTML = topGames.map(game => `
                <label class="flex items-center space-x-3 p-2 rounded-md hover:bg-gray-100 cursor-pointer">
                    <input type="checkbox" name="game-vote" value="${game.name}" class="h-4 w-4 rounded text-blue-600 focus:ring-blue-500">
                    <img src="${game.header_image}" class="w-16 h-8 object-cover rounded-md">
                    <span class="font-medium">${game.name}</span>
                </label>
            `).join('');

            schedulerModalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Create a Game Poll</h2>
                    <button id="close-scheduler-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>
                <p class="mb-4 text-gray-600">Select from your top shared games to create a poll for your friends.</p>
                <div class="mb-4">
                    <label class="font-bold text-gray-800">1. Select games to vote on:</label>
                    <div class="mt-2 space-y-1 max-h-60 overflow-y-auto pr-2">${gameOptionsHTML}</div>
                </div>
                <button id="create-poll-btn" class="w-full mt-4 bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition">Generate Poll Text</button>
                <div id="poll-output" class="hidden mt-6">
                    <label class="font-bold text-gray-800">2. Copy & Paste this into your chat:</label>
                    <textarea id="poll-textarea" class="w-full p-2 border rounded-md bg-gray-100 mt-2" rows="6" readonly></textarea>
                    <button id="copy-poll-btn" class="w-full mt-2 bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700">Copy Poll</button>
                </div>
            `;
            
            schedulerModal.classList.remove('hidden');
            setTimeout(() => {
                schedulerModal.classList.remove('opacity-0');
                schedulerModalContent.classList.remove('scale-95');
            }, 10);

            document.getElementById('close-scheduler-btn').addEventListener('click', hideSchedulerModal);
            document.getElementById('create-poll-btn').addEventListener('click', createPollText);
        }

        function hideSchedulerModal() {
            schedulerModal.classList.add('opacity-0');
            schedulerModalContent.classList.add('scale-95');
            setTimeout(() => schedulerModal.classList.add('hidden'), 300);
        }

        function createPollText() {
            const selectedGames = Array.from(document.querySelectorAll('input[name="game-vote"]:checked')).map(cb => cb.value);
            if (selectedGames.length === 0) {
                alert('Please select at least one game to vote on.');
                return;
            }
            
            let pollText = "Alright team, what are we playing tonight? Vote with a reaction!\n\n";
            const emojis = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£', 'ðŸ”Ÿ'];
            selectedGames.forEach((game, index) => {
                pollText += `${emojis[index] || 'âž¡ï¸'} ${game}\n`;
            });

            const pollOutput = document.getElementById('poll-output');
            const pollTextarea = document.getElementById('poll-textarea');
            pollTextarea.value = pollText;
            pollOutput.classList.remove('hidden');

            const copyBtn = document.getElementById('copy-poll-btn');
            copyBtn.addEventListener('click', () => {
                pollTextarea.select();
                document.execCommand('copy');
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = 'Copy Poll', 2000);
            });
        }
        
        function saveGroup() {
            const name = groupNameInput.value.trim();
            if (!name) {
                alert('Please enter a group name.');
                return;
            }
            if (selectedFriendIds.size === 0) {
                alert('Please select friends to save to the group.');
                return;
            }
            savedGroups[name] = [...selectedFriendIds];
            localStorage.setItem('steamFriendGroups', JSON.stringify(savedGroups));
            alert(`Group "${name}" saved!`);
            groupNameInput.value = '';
            loadSavedGroups();
        }

        function loadSavedGroups() {
            savedGroupsSelect.innerHTML = '<option value="">Load a saved group...</option>';
            for (const name in savedGroups) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                savedGroupsSelect.appendChild(option);
            }
        }
        
        function deleteGroup() {
            const groupName = savedGroupsSelect.value;
            if (!groupName) {
                alert('Please select a group to delete.');
                return;
            }
            if (confirm(`Are you sure you want to delete the group "${groupName}"?`)) {
                delete savedGroups[groupName];
                localStorage.setItem('steamFriendGroups', JSON.stringify(savedGroups));
                alert(`Group "${groupName}" deleted.`);
                loadSavedGroups();
            }
        }
        
        function handleGroupLoad(e) {
            const groupName = e.target.value;
            if (!groupName) {
                selectedFriendIds.clear();
            } else {
                selectedFriendIds = new Set(savedGroups[groupName]);
            }
            const currentSearch = friendSearchInput.value.toLowerCase();
            const filteredFriends = friends.filter(f => (f.personaname || '').toLowerCase().includes(currentSearch));
            displayFriends(filteredFriends);
            updateSharedGames();
            updateSelectedFriendsList();
        }

        helpIcon.addEventListener('click', showHelpModal);
        helpModal.addEventListener('click', (e) => { if (e.target === helpModal) hideHelpModal(); });
        schedulerModal.addEventListener('click', (e) => { if (e.target === schedulerModal) hideSchedulerModal(); });
        planGameNightBtn.addEventListener('click', showSchedulerModal);
        saveGroupBtn.addEventListener('click', saveGroup);
        savedGroupsSelect.addEventListener('change', handleGroupLoad);
        deleteGroupBtn.addEventListener('click', deleteGroup);

    </script>
</body>
</html>
